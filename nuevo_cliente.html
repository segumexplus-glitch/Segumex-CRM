<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Nuevo Cliente - Segumex</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-dark": "#101622",
                        "surface-dark": "#111318",
                        "surface-card": "#1c1f27",
                        "text-secondary": "#9da6b9"
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] }
                },
            },
        }
    </script>
</head>

<body class="bg-[#f6f6f8] dark:bg-background-dark font-display text-white">
    <div class="flex h-screen w-full">
        <aside class="flex w-64 flex-col border-r border-[#3b4354] bg-[#111318] flex-shrink-0">
            <div class="flex h-full flex-col justify-between p-4">
                <div class="flex flex-col gap-6">
                    <div class="flex items-center gap-3 px-2">
                        <div
                            class="bg-primary h-10 w-10 rounded-full flex items-center justify-center font-bold text-white">
                            SX</div>
                        <div class="flex flex-col">
                            <h1 class="text-white text-base font-semibold leading-tight">Segumex</h1>
                            <p class="text-text-secondary text-xs font-normal">Panel Principal</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <a class="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-[#282e39] transition-colors group"
                            href="index.html">
                            <span
                                class="material-symbols-outlined text-[#9da6b9] group-hover:text-white">dashboard</span>
                            <p class="text-[#9da6b9] group-hover:text-white text-sm font-medium">Dashboard</p>
                        </a>
                        <a class="flex items-center gap-3 px-3 py-3 rounded-lg bg-primary/10 text-primary border border-primary/20"
                            href="clientes.html">
                            <span class="material-symbols-outlined">group</span>
                            <p class="text-sm font-bold">Clientes</p>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-y-auto bg-background-dark p-4 md:p-8">
            <div class="max-w-4xl mx-auto w-full pb-10">
                <div class="flex items-center gap-4 mb-8">
                    <a href="clientes.html" class="p-2 rounded-full hover:bg-[#282e39] transition-colors">
                        <span class="material-symbols-outlined text-[#9da6b9]">arrow_back</span>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-white">Registrar Nuevo Cliente</h1>
                        <p class="text-[#9da6b9] text-sm">Los datos se guardarán directamente en Google Drive.</p>
                    </div>
                </div>

                <div class="bg-surface-card border border-[#3b4354] rounded-xl p-6 shadow-lg">
                    <form id="clientForm">

                        <div class="flex flex-col md:flex-row gap-8 items-start border-b border-[#3b4354] pb-8">
                            <div class="flex flex-col gap-3 items-center">
                                <label class="block text-sm font-medium text-[#9da6b9]">Foto de Perfil</label>
                                <div class="relative group cursor-pointer">
                                    <div
                                        class="w-32 h-32 rounded-full bg-[#111318] border-2 border-dashed border-[#3b4354] flex items-center justify-center overflow-hidden group-hover:border-primary transition-colors">
                                        <span
                                            class="material-symbols-outlined text-4xl text-[#3b4354] group-hover:text-primary transition-colors">add_a_photo</span>
                                        <img id="preview" class="absolute w-full h-full object-cover hidden" />
                                    </div>
                                    <input type="file" id="fotoInput" class="absolute inset-0 opacity-0 cursor-pointer"
                                        onchange="previewImage(this)">
                                </div>
                            </div>

                            <div class="flex-1 w-full space-y-4">
                                <label class="block text-sm font-medium text-[#9da6b9]">Tipo de Cliente</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="tipo_cliente" value="Fisica" class="peer sr-only"
                                            checked>
                                        <div
                                            class="rounded-lg border border-[#3b4354] bg-[#111318] p-4 hover:bg-[#282e39] peer-checked:border-primary peer-checked:bg-primary/10 transition-all flex flex-col items-center gap-2">
                                            <span class="material-symbols-outlined text-white">person</span>
                                            <span class="text-sm font-bold text-white">Persona Física</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="tipo_cliente" value="Empresa" class="peer sr-only">
                                        <div
                                            class="rounded-lg border border-[#3b4354] bg-[#111318] p-4 hover:bg-[#282e39] peer-checked:border-primary peer-checked:bg-primary/10 transition-all flex flex-col items-center gap-2">
                                            <span class="material-symbols-outlined text-white">business</span>
                                            <span class="text-sm font-bold text-white">Empresa</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">id_card</span> Datos Generales
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Nombre Completo</label>
                                    <input type="text" id="nombre"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white focus:ring-1 focus:ring-primary focus:border-primary"
                                        placeholder="Ej. Juan Pérez">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">RFC</label>
                                    <input type="text" id="rfc"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white focus:ring-1 focus:ring-primary focus:border-primary uppercase">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Correo
                                        Electrónico</label>
                                    <input type="email" id="email"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white focus:ring-1 focus:ring-primary focus:border-primary">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Teléfono</label>
                                    <input type="tel" id="telefono"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white focus:ring-1 focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-[#3b4354] pt-6">
                            <h3 class="text-white font-semibold mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">location_on</span> Dirección
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Calle y Número</label>
                                    <input type="text" id="calle"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Código Postal</label>
                                    <input type="number" id="cp"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Colonia</label>
                                    <input type="text" id="colonia"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Municipio /
                                        Alcaldía</label>
                                    <input type="text" id="municipio"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-[#9da6b9] mb-2">Estado</label>
                                    <select id="estado"
                                        class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-3 text-white">
                                        <option value="">Seleccionar...</option>
                                        <option value="Aguascalientes">Aguascalientes</option>
                                        <option value="CDMX">Ciudad de México</option>
                                        <option value="Jalisco">Jalisco</option>
                                        <option value="Nuevo León">Nuevo León</option>
                                        <option value="EdoMex">Estado de México</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="pt-6 flex justify-end gap-3 border-t border-[#3b4354]">
                            <a href="clientes.html"
                                class="px-6 py-3 rounded-lg border border-[#3b4354] text-[#9da6b9] hover:text-white hover:bg-[#282e39] transition-colors font-medium">Cancelar</a>

                            <button type="button" id="btnGuardar" onclick="enviarAGoogle()"
                                class="px-6 py-3 rounded-lg bg-primary hover:bg-blue-600 text-white font-bold shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">cloud_upload</span>
                                <span id="btnTexto">Guardar en Nube</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 1. Previsualizar imagen
        let fileSeleccionado = null;

        // 1. Previsualizar imagen y guardar referencia al archivo
        function previewImage(input) {
            if (input.files && input.files[0]) {
                fileSeleccionado = input.files[0]; // Guardar archivo para subir despues

                var reader = new FileReader();
                reader.onload = function (e) {
                    var preview = document.getElementById('preview');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ==========================================
        // ⚠️ PEGA AQUÍ TU URL (No borres las comillas)
        // ==========================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/accounts?authuser=1&continueUrl=https%3A%2F%2Fscript.google.com%2Faccounts%3Fauthuser%3D1%26continueUrl%3Dhttps%253A%252F%252Fscript.google.com%252Faccounts%253Fauthuser%253D1%2526continueUrl%253Dhttps%25253A%25252F%25252Fscript.google.com%25252Faccounts%25253Fauthuser%25253D1%252526continueUrl%25253Dhttps%2525253A%2525252F%2525252Fscript.google.com%2525252Faccounts%2525253Fauthuser%2525253D1%25252526continueUrl%2525253Dhttps%252525253A%252525252F%252525252Fscript.google.com%252525252Faccounts%252525253Fauthuser%252525253D1%2525252526continueUrl%252525253Dhttps%25252525253A%25252525252F%25252525252Fscript.google.com%25252525252Faccounts%25252525253Fauthuser%25252525253D1%252525252526continueUrl%25252525253Dhttps%2525252525253A%2525252525252F%2525252525252Fscript.google.com%2525252525252Faccounts%2525252525253Fauthuser%2525252525253D1%25252525252526continueUrl%2525252525253Dhttps%252525252525253A%252525252525252F%252525252525252Fscript.google.com%252525252525252Faccounts%252525252525253Fauthuser%252525252525253D1%2525252525252526continueUrl%252525252525253Dhttps%25252525252525253A%25252525252525252F%25252525252525252Fscript.google.com%25252525252525252Faccounts%25252525252525253Fauthuser%25252525252525253D1%252525252525252526continueUrl%25252525252525253Dhttps%2525252525252525253A%2525252525252525252F%2525252525252525252Fscript.google.com%2525252525252525252Faccounts%2525252525252525253Fauthuser%2525252525252525253D1%25252525252525252526continueUrl%2525252525252525253Dhttps%252525252525252525253A%252525252525252525252F%252525252525252525252Fscript.google.com%252525252525252525252Faccounts%252525252525252525253Fauthuser%252525252525252525253D1%2525252525252525252526continueUrl%252525252525252525253Dhttps%25252525252525252525253A%25252525252525252525252F%25252525252525252525252Fscript.google.com%25252525252525252525252Faccounts%25252525252525252525253Fauthuser%25252525252525252525253D1%252525252525252525252526continueUrl%25252525252525252525253Dhttps%2525252525252525252525253A%2525252525252525252525252F%2525252525252525252525252Fscript.google.com%2525252525252525252525252Faccounts%2525252525252525252525253Fauthuser%2525252525252525252525253D1%25252525252525252525252526continueUrl%2525252525252525252525253Dhttps%252525252525252525252525253A%252525252525252525252525252F%252525252525252525252525252Fscript.google.com%252525252525252525252525252Faccounts%252525252525252525252525253Fauthuser%252525252525252525252525253D1%2525252525252525252525252526continueUrl%252525252525252525252525253Dhttps%25252525252525252525252525253A%25252525252525252525252525252F%25252525252525252525252525252Fscript.google.com%25252525252525252525252525252Faccounts%25252525252525252525252525253Fauthuser%25252525252525252525252525253D1%252525252525252525252525252526continueUrl%25252525252525252525252525253Dhttps%2525252525252525252525252525253A%2525252525252525252525252525252F%2525252525252525252525252525252Fscript.google.com%2525252525252525252525252525252Faccounts%2525252525252525252525252525253Fauthuser%2525252525252525252525252525253D1%25252525252525252525252525252526continueUrl%2525252525252525252525252525253Dhttps%252525252525252525252525252525253A%252525252525252525252525252525252F%252525252525252525252525252525252Fscript.google.com%252525252525252525252525252525252Faccounts%252525252525252525252525252525253Fauthuser%252525252525252525252525252525253D1%2525252525252525252525252525252526continueUrl%252525252525252525252525252525253Dhttps%25252525252525252525252525252525253A%25252525252525252525252525252525252F%25252525252525252525252525252525252Fscript.google.com%25252525252525252525252525252525252Faccounts%25252525252525252525252525252525253Fauthuser%25252525252525252525252525252525253D1%252525252525252525252525252525252526continueUrl%25252525252525252525252525252525253Dhttps%2525252525252525252525252525252525253A%2525252525252525252525252525252525252F%2525252525252525252525252525252525252Fscript.google.com%2525252525252525252525252525252525252Fmacros%2525252525252525252525252525252525252Fu%2525252525252525252525252525252525252F1%2525252525252525252525252525252525252Fstart%2525252525252525252525252525252525253Fmid%2525252525252525252525252525252525253DACjPJvGgYHKohICTRkSM88nFycbHUIMaUPylP8nE6zSfNs6KJB3ArVvlbJDm2St3POCB6RCnEDVcMPNGCOChVjpSXwhjo5saQnSUJwjravVlNsSI6Ya9TFIfQ0Ik1bDPSLonm85KrQaJ4Q%25252525252525252525252525252525252526uiv%2525252525252525252525252525252525253D2%25252525252525252525252525252525252526emtoken%2525252525252525252525252525252525253DARViON6oVpLqKUYjyKBz5mj1tsfA%252525252525252525252525252525252525253A1767810226528";

        async function enviarAGoogle() {
            const btn = document.getElementById('btnGuardar');
            const btnTexto = document.getElementById('btnTexto');

            // Validar nombre
            const nombre = document.getElementById('nombre').value;
            if (!nombre) { alert("El nombre es obligatorio"); return; }

            // Mostrar estado "Cargando"
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btnTexto.innerText = "Subiendo foto y guardando...";

            try {
                // 1. Subir Foto a Supabase Storage (si existe)
                let publicUrl = null;
                if (fileSeleccionado) {
                    const fileName = `cliente_${Date.now()}_${fileSeleccionado.name.replace(/\s/g, '_')}`;
                    const { data: dataUpload, error: errorUpload } = await window.supabaseClient
                        .storage
                        .from('fotos-clientes')
                        .upload(fileName, fileSeleccionado, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (errorUpload) {
                        console.error("Error subiendo imagen:", errorUpload);
                        // No bloqueamos el guardado, solo avisamos (o podríamos hacer return)
                    } else {
                        // Obtener URL Pública
                        const { data: dataUrl } = window.supabaseClient
                            .storage
                            .from('fotos-clientes')
                            .getPublicUrl(fileName);
                        publicUrl = dataUrl.publicUrl;
                    }
                }

                // 2. Preparar objeto para Supabase DB
                // Usamos Date.now() para ID numérico compatible con el resto del sistema
                const nuevoCliente = {
                    id: Date.now(),
                    nombre: nombre,
                    apellido: "", // El form original no pide apellido, lo dejamos vacío o split nombre
                    email: document.getElementById('email').value,
                    rfc: document.getElementById('rfc').value,
                    telefono: document.getElementById('telefono').value,
                    tipo: document.querySelector('input[name="tipo_cliente"]:checked').value,
                    direccion: document.getElementById('calle').value, // Mapeo simplificado
                    cp: document.getElementById('cp').value,
                    colonia: document.getElementById('colonia').value,
                    municipio: document.getElementById('municipio').value,
                    estado_geo: document.getElementById('estado').value,
                    estatus: "Prospecto",
                    imagen_url: publicUrl // Aquí va la URL corta del Storage
                };

                // 3. Insertar en Supabase Database
                const { error: errorInsert } = await window.supabaseClient
                    .from('clientes')
                    .insert([nuevoCliente]);

                if (errorInsert) throw errorInsert;

                // 4. (Opcional) Enviar a Google Sheets como backup (Fondo)
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoCliente)
                }).catch(e => console.log("Google Sheets backup skipped/failed", e));

                alert("✅ Cliente guardado exitosamente en la nube (Storage + DB)!");
                window.location.href = 'clientes.html';

            } catch (error) {
                console.error('Error general:', error);
                alert("Hubo un error al guardar los datos: " + error.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btnTexto.innerText = "Guardar en Nube";
            }
        }
    </script>
</body>

</html>