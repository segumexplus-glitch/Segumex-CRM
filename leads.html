<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Pipeline de Ventas - Segumex</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="ui.css" rel="stylesheet" />
    <script src="ui.js"></script>
    <script>
        // --- SCRIPT DE SEGURIDAD ---
        (async function () {
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
        })();
        // ---------------------------

        tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#135bec", "background-dark": "#101622", "surface-dark": "#111318", "surface-card": "#1c1f27", "text-secondary": "#9da6b9" }, fontFamily: { "display": ["Inter", "sans-serif"] } } } }
    </script>
</head>

<body class="bg-[#f6f6f8] dark:bg-background-dark font-display text-white relative" onload="cargarLeads()">
    <!-- Overlay Mobile -->
    <div id="sidebarOverlay" onclick="toggleMenu()"
        class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass transition-opacity"></div>

    <div class="flex h-screen w-full overflow-hidden">

        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-[#3b4354] bg-[#111318] flex-shrink-0 shadow-2xl md:shadow-none">
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden bg-background-dark relative w-full">
            <!-- Mobile Header / Toggle -->
            <div class="md:hidden p-4 pb-0 flex items-center gap-3">
                <button onclick="toggleMenu()" class="p-2 -ml-2 text-white hover:bg-white/10 rounded-lg">
                    <span class="material-symbols-outlined text-2xl">menu</span>
                </button>
                <span class="font-bold text-lg">Segumex</span>
            </div>

            <div class="px-6 py-4 border-b border-[#3b4354] flex justify-between items-center bg-[#161b22]">
                <h1 class="text-xl font-bold flex items-center gap-2"><span
                        class="material-symbols-outlined text-primary">filter_alt</span> Pipeline de Ventas</h1>
                <button onclick="abrirModalNuevo()"
                    class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 shadow-lg shadow-primary/30">
                    <span class="material-symbols-outlined">add</span> Nueva Oportunidad
                </button>
            </div>

            <div class="px-6 py-3 border-b border-[#3b4354] flex gap-3 overflow-x-auto">
                <span class="text-xs font-bold text-[#9da6b9] uppercase tracking-wider self-center">Filtros:</span>
                <button
                    class="px-3 py-1 rounded-full bg-[#282e39] border border-[#3b4354] text-xs text-white hover:border-primary transition-colors">Esta
                    Semana</button>
                <button
                    class="px-3 py-1 rounded-full bg-[#282e39] border border-[#3b4354] text-xs text-white hover:border-primary transition-colors">Seguros
                    de Vida</button>
                <button
                    class="px-3 py-1 rounded-full bg-primary/20 border border-primary/50 text-xs text-primary font-bold">Alta
                    Probabilidad (IA)</button>
            </div>

            <div class="flex-1 overflow-x-auto overflow-y-hidden p-6">
                <div class="flex gap-6 h-full min-w-[1000px]">

                    <div class="flex-1 flex flex-col min-w-[280px]">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h3 class="font-bold text-white">Nuevo Lead <span id="count-nuevo"
                                    class="ml-2 text-xs bg-[#282e39] px-2 py-0.5 rounded text-[#9da6b9]">0</span></h3>
                        </div>
                        <div id="col-nuevo" class="flex-1 overflow-y-auto pr-2 space-y-3">
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-[280px]">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h3 class="font-bold text-white">Calificado <span id="count-calificado"
                                    class="ml-2 text-xs bg-[#282e39] px-2 py-0.5 rounded text-[#9da6b9]">0</span></h3>
                        </div>
                        <div id="col-calificado" class="flex-1 overflow-y-auto pr-2 space-y-3"></div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-[280px]">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h3 class="font-bold text-white">Cotización <span id="count-cotizacion"
                                    class="ml-2 text-xs bg-[#282e39] px-2 py-0.5 rounded text-[#9da6b9]">0</span></h3>
                        </div>
                        <div id="col-cotizacion" class="flex-1 overflow-y-auto pr-2 space-y-3"></div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-[280px]">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <h3 class="font-bold text-white">Cierre <span id="count-cierre"
                                    class="ml-2 text-xs bg-[#282e39] px-2 py-0.5 rounded text-[#9da6b9]">0</span></h3>
                        </div>
                        <div id="col-cierre" class="flex-1 overflow-y-auto pr-2 space-y-3"></div>
                    </div>

                </div>
            </div>
        </main>

        <div id="modalNuevoLead"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in">
            <div class="bg-[#1c1f27] border border-[#3b4354] rounded-xl w-full max-w-md p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white">Nuevo Prospecto</h2>
                    <button onclick="cerrarModalNuevo()" class="text-[#9da6b9] hover:text-white"><span
                            class="material-symbols-outlined">close</span></button>
                </div>
                <form onsubmit="guardarLead(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-[#9da6b9] mb-1">Nombre del Prospecto</label>
                        <input type="text" id="nombreLead" required
                            class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-[#9da6b9] mb-1">Producto</label>
                            <select id="productoLead"
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                                <option value="Seguro de Vida">Seguro de Vida</option>
                                <option value="Gastos Médicos">Gastos Médicos</option>
                                <option value="Autos">Autos</option>
                                <option value="Flotilla">Flotilla</option>
                                <option value="Daños">Daños</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#9da6b9] mb-1">Valor Est. (MXN)</label>
                            <input type="number" id="valorLead" required
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm"
                                placeholder="0.00">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-[#9da6b9] mb-1">Probabilidad</label>
                            <select id="probLead"
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                                <option value="Baja">Baja</option>
                                <option value="Media">Media</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-[#9da6b9] mb-1">Etapa Inicial</label>
                            <select id="etapaLead"
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                                <option value="nuevo">Nuevo Lead</option>
                                <option value="calificado">Calificado</option>
                                <option value="cotizacion">Cotización</option>
                                <option value="cierre">Cierre</option>
                            </select>
                        </div>
                    </div>
                    <div class="border-t border-[#3b4354] pt-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-[#9da6b9] mb-1">Teléfono</label>
                                <input type="tel" id="telLead"
                                    class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-[#9da6b9] mb-1">Email</label>
                                <input type="email" id="emailLead"
                                    class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 flex justify-end gap-2">
                        <button type="button" onclick="cerrarModalNuevo()"
                            class="px-4 py-2 text-sm text-[#9da6b9] hover:text-white">Cancelar</button>
                        <button type="submit"
                            class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-primary/20">Crear
                            Lead</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="menu.js"></script>

    <script>
        async function cargarLeads() {
            // --- CONSULTA SUPABASE ---
            const { data: leads, error } = await window.supabaseClient.from('leads').select('*');
            if (error) return;

            // Limpiar columnas
            ['nuevo', 'calificado', 'cotizacion', 'cierre'].forEach(c => {
                document.getElementById(`col-${c}`).innerHTML = '';
                document.getElementById(`count-${c}`).innerText = '0';
            });

            const contadores = { nuevo: 0, calificado: 0, cotizacion: 0, cierre: 0 };

            leads.forEach(l => {
                if (l.etapa === 'ganada') return;

                const col = document.getElementById(`col-${l.etapa}`);
                if (col) {
                    contadores[l.etapa]++;

                    let tagColor = "bg-blue-500/10 text-blue-400 border-blue-500/20";
                    if (l.producto === 'Seguro de Vida') tagColor = "bg-purple-500/10 text-purple-400 border-purple-500/20";
                    if (l.producto === 'Autos' || l.producto === 'Flotilla') tagColor = "bg-orange-500/10 text-orange-400 border-orange-500/20";

                    let probBadge = "";
                    if (l.prob === "Alta") probBadge = `<span class="text-[10px] font-bold px-2 py-0.5 rounded bg-green-500/20 text-green-400 border border-green-500/30 flex items-center gap-1"><span class="material-symbols-outlined text-[10px]">auto_awesome</span> Alta Prob.</span>`;

                    const card = `
                    <div onclick="window.location.href='detalle_lead.html?id=${l.id}'" class="bg-surface-card border border-[#3b4354] rounded-xl p-4 cursor-pointer hover:border-primary transition-all group shadow-sm hover:shadow-md hover:shadow-black/40 relative">
                        
                         <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <button onclick="procesarGanada(event, ${l.id})" class="p-1 bg-green-500/20 text-green-500 hover:bg-green-500 hover:text-white rounded shadow-lg backdrop-blur-sm" title="Venta Ganada"><span class="material-symbols-outlined text-[18px]">check_circle</span></button>
                            <button onclick="borrarLead(event, ${l.id})" class="p-1 bg-red-500/20 text-red-500 hover:bg-red-500 hover:text-white rounded shadow-lg backdrop-blur-sm"><span class="material-symbols-outlined text-[18px]">delete</span></button>
                        </div>
                        
                        <div class="flex justify-between items-start mb-2 pr-6">
                            <div class="flex items-center gap-2">
                                <div class="size-8 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center font-bold text-xs border border-white/10">${l.nombre.charAt(0)}</div>
                                <h4 class="font-bold text-sm text-white group-hover:text-primary transition-colors truncate w-32">${l.nombre}</h4>
                            </div>
                        </div>
                        <span class="text-[#9da6b9] text-[10px] block mb-2">${l.fecha}</span>
                        
                        <div class="flex items-center gap-2 mb-3 flex-wrap">
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold border ${tagColor}">${l.producto}</span>
                            ${probBadge}
                        </div>

                        <div class="flex justify-between items-end mt-2 pt-2 border-t border-[#3b4354]">
                            <div>
                                <p class="text-[#9da6b9] text-[10px] uppercase">Valor Est.</p>
                                <p class="text-white font-bold text-sm">$${new Intl.NumberFormat('es-MX').format(l.valor)}</p>
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-symbols-outlined text-[#9da6b9] hover:text-white text-sm">arrow_forward</span>
                            </div>
                        </div>
                    </div>
                `;
                    col.innerHTML += card;
                }
            });

            // Actualizar contadores
            Object.keys(contadores).forEach(key => {
                document.getElementById(`count-${key}`).innerText = contadores[key];
            });
        }

        async function procesarGanada(e, idLead) {
            e.stopPropagation();
            if (!confirm("¿Confirmar Venta Ganada? Esto creará el Cliente y la Póliza automáticamente.")) return;

            // Obtener Sesión para asignar Agente
            const sesion = JSON.parse(localStorage.getItem('segumex_sesion')) || { nombre: 'Agente Segumex' };
            const agenteAsignado = sesion.nombre || 'Agente Segumex';

            const { data: lead } = await window.supabaseClient.from('leads').select('*').eq('id', idLead).single();

            if (lead) {
                const btn = e.currentTarget;
                window.SegumexUI.setLoading(btn, "...");

                // 1. Crear Cliente (ID Autogenerado por DB)
                const nuevoCliente = {
                    nombre: lead.nombre, // Supabase ID is serial/uuid
                    tipo: "Persona",
                    estatus: "Activo",
                    email: lead.email || "pendiente@email.com",
                    telefono: lead.telefono || "",
                    nacimiento: null,
                    agente: agenteAsignado, // IMPORTANTE: Asignar al dueño
                    restringida: false
                };

                // Insertar Cliente y RETORNAR el objeto creado para obtener su ID real
                const { data: clienteCreado, error: errCli } = await window.supabaseClient
                    .from('clientes')
                    .insert([nuevoCliente])
                    .select()
                    .single();

                if (errCli) {
                    alert("Error creando cliente: " + errCli.message);
                    window.SegumexUI.resetLoading(btn);
                    return;
                }

                // 2. Crear Póliza vinculada al Cliente Real
                const nuevaPoliza = {
                    cliente_id: clienteCreado.id, // ID Real de la DB
                    ramo: lead.producto,
                    aseguradora: "Por Asignar",
                    no_poliza: "PEND-" + Math.floor(Math.random() * 10000), // Temporal hasta que User edite
                    vence: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                    estado: "vigente",
                    prima: lead.valor,
                    agente: agenteAsignado, // IMPORTANTE: Asignar al dueño
                    restringida: false,
                    icono: 'pending',
                    estiloIcono: 'text-gray-400 bg-gray-500/10'
                };

                const { error: errPol } = await window.supabaseClient.from('polizas').insert([nuevaPoliza]);

                if (errPol) {
                    alert("Cliente creado, pero error en póliza: " + errPol.message);
                } else {
                    // Actualizar Lead a Ganada
                    await window.supabaseClient.from('leads').update({ etapa: 'ganada' }).eq('id', idLead);
                    cargarLeads();
                    alert(`¡Venta procesada con éxito!\nCliente: ${clienteCreado.nombre}\nAsignado a: ${agenteAsignado}`);
                }
                window.SegumexUI.resetLoading(btn);
            }
        }

        function abrirModalNuevo() {
            document.getElementById('modalNuevoLead').classList.remove('hidden');
        }

        function cerrarModalNuevo() {
            document.getElementById('modalNuevoLead').classList.add('hidden');
            document.getElementById('nombreLead').value = '';
            document.getElementById('valorLead').value = '';
            document.getElementById('telLead').value = '';
            document.getElementById('emailLead').value = '';
        }

        async function guardarLead(e) {
            e.preventDefault();
            const btnSubmit = e.target.querySelector('button[type="submit"]'); // Use querySelector on form
            window.SegumexUI.setLoading(btnSubmit, "Guardando...");

            const nuevo = {
                // id: Autogenerado
                nombre: document.getElementById('nombreLead').value,
                producto: document.getElementById('productoLead').value,
                valor: parseFloat(document.getElementById('valorLead').value) || 0,
                prob: document.getElementById('probLead').value,
                etapa: document.getElementById('etapaLead').value,
                telefono: document.getElementById('telLead').value,
                email: document.getElementById('emailLead').value,
                fecha: new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'short' })
            };

            const { error } = await window.supabaseClient.from('leads').insert([nuevo]);

            window.SegumexUI.resetLoading(btnSubmit);

            if (!error) {
                cerrarModalNuevo();
                cargarLeads();
            } else {
                alert("Error al guardar lead");
            }
        }

        async function borrarLead(e, id) {
            e.stopPropagation();
            if (confirm("¿Eliminar esta oportunidad?")) {
                const { error } = await window.supabaseClient.from('leads').delete().eq('id', id);
                if (!error) cargarLeads();
            }
        }
    </script>
</body>

</html>