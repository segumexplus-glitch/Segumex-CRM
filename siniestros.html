<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Siniestros - Segumex</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link href="ui.css" rel="stylesheet" />
    <script src="ui.js"></script>
    <script>
        // --- SCRIPT DE SEGURIDAD MODIFICADO ---
        (async function () {
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
        })();
        // ---------------------------

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#3b82f6",
                        "background-dark": "#0f111a",
                        "surface-dark": "#161b22",
                        "surface-card": "#1f242e",
                        "text-secondary": "#94a3b8"
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] }
                },
            },
        }
    </script>
    <style>
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #1f242e;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-background-dark font-display text-white overflow-hidden relative" onload="cargarSiniestros()">
    <!-- Overlay Mobile -->
    <div id="sidebarOverlay" onclick="toggleMenu()"
        class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass transition-opacity"></div>

    <div class="flex h-screen w-full overflow-hidden">

        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-[#2d3442] bg-[#161b22] flex-shrink-0 shadow-2xl md:shadow-none">
        </aside>

        <main class="flex-1 flex flex-col h-full relative w-full">
            <!-- Mobile Header / Toggle -->
            <div class="md:hidden p-4 pb-0 flex items-center gap-3 bg-[#161b22]">
                <button onclick="toggleMenu()" class="p-2 -ml-2 text-white hover:bg-white/10 rounded-lg">
                    <span class="material-symbols-outlined text-2xl">menu</span>
                </button>
                <span class="font-bold text-lg">Segumex</span>
            </div>

            <header
                class="h-auto md:h-20 py-4 md:py-0 border-b border-[#2d3442] bg-[#161b22] flex flex-col md:flex-row items-start md:items-center justify-between px-6 md:px-8 shrink-0 gap-4">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-white">Listado de Siniestros</h1>
                    <p class="text-[#94a3b8] text-sm mt-1">Gestiona y da seguimiento a los reclamos de tus asegurados.
                    </p>
                </div>
                <button onclick="abrirModalSiniestro()"
                    class="bg-primary hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-blue-900/30 transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[20px]">add</span> Nuevo Siniestro
                </button>
            </header>

            <div class="flex-1 overflow-y-auto custom-scroll p-8">
                <div class="max-w-[1600px] mx-auto flex flex-col gap-8">

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-surface-card border border-[#2d3442] rounded-xl p-5 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-[#94a3b8] text-xs font-bold uppercase tracking-wider">Siniestros
                                    Abiertos</span>
                                <span class="material-symbols-outlined text-[#3b82f6] opacity-50">folder_open</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <h2 class="text-3xl font-bold text-white" id="kpiAbiertos">0</h2>
                                <span class="text-green-500 text-xs font-medium flex items-center">Activos</span>
                            </div>
                        </div>
                        <div class="bg-surface-card border border-[#2d3442] rounded-xl p-5 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-[#94a3b8] text-xs font-bold uppercase tracking-wider">En
                                    Revisi√≥n</span>
                                <span class="material-symbols-outlined text-yellow-500 opacity-50">pending</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <h2 class="text-3xl font-bold text-white" id="kpiRevision">0</h2>
                                <span class="text-[#94a3b8] text-xs font-medium">En espera</span>
                            </div>
                        </div>
                        <div class="bg-surface-card border border-[#2d3442] rounded-xl p-5 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-[#94a3b8] text-xs font-bold uppercase tracking-wider">Cerrados
                                    (Total)</span>
                                <span class="material-symbols-outlined text-green-500 opacity-50">check_circle</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <h2 class="text-3xl font-bold text-white" id="kpiCerrados">0</h2>
                                <span class="text-green-500 text-xs font-medium flex items-center">Finalizados</span>
                            </div>
                        </div>
                        <div class="bg-[#1a1010] border border-red-900/30 rounded-xl p-5 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-red-400 text-xs font-bold uppercase tracking-wider">Urgentes</span>
                                <span class="material-symbols-outlined text-red-500 opacity-80">warning</span>
                            </div>
                            <div class="flex items-baseline gap-2">
                                <h2 class="text-3xl font-bold text-white" id="kpiUrgentes">0</h2>
                                <span class="text-red-400 text-xs font-medium">Atenci√≥n</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap items-center gap-4 bg-[#161b22] border border-[#2d3442] p-2 rounded-xl">
                        <div class="relative flex-1 min-w-[200px]">
                            <span
                                class="absolute left-3 top-2.5 material-symbols-outlined text-[#94a3b8] text-[18px]">search</span>
                            <input type="text" id="buscador" onkeyup="aplicarFiltros()"
                                placeholder="Buscar por p√≥liza, titular o ID..."
                                class="w-full bg-[#0f111a] border border-[#2d3442] rounded-lg pl-9 pr-4 py-2 text-sm text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none placeholder-[#475569]">
                        </div>
                        <div class="h-8 w-px bg-[#2d3442]"></div>
                        <div class="flex items-center gap-3">
                            <label class="text-[#94a3b8] text-xs font-medium">Status:</label>
                            <select id="filtroStatus" onchange="aplicarFiltros()"
                                class="bg-[#0f111a] border border-[#2d3442] text-white text-sm rounded-lg px-3 py-2 outline-none focus:border-primary">
                                <option value="Todos">Todos</option>
                                <option value="Abierto">Abierto</option>
                                <option value="En Revisi√≥n">En Revisi√≥n</option>
                                <option value="Urgente">Urgente</option>
                                <option value="Cerrado">Cerrado</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-surface-card border border-[#2d3442] rounded-xl overflow-hidden shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="border-b border-[#2d3442] bg-[#161b22]">
                                        <th class="p-4 text-[11px] font-bold tracking-wider text-[#94a3b8] uppercase">ID
                                            / P√≥liza</th>
                                        <th class="p-4 text-[11px] font-bold tracking-wider text-[#94a3b8] uppercase">
                                            Titular</th>
                                        <th class="p-4 text-[11px] font-bold tracking-wider text-[#94a3b8] uppercase">
                                            Tipo Siniestro</th>
                                        <th class="p-4 text-[11px] font-bold tracking-wider text-[#94a3b8] uppercase">
                                            Fecha Evento</th>
                                        <th class="p-4 text-[11px] font-bold tracking-wider text-[#94a3b8] uppercase">
                                            Status</th>
                                        <th
                                            class="p-4 text-[11px] font-bold tracking-wider text-[#94a3b8] uppercase text-right">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaSiniestros" class="divide-y divide-[#2d3442]">
                                </tbody>
                            </table>
                            <div id="sin-datos"
                                class="hidden flex flex-col items-center justify-center p-16 text-[#94a3b8]">
                                <span class="material-symbols-outlined text-5xl mb-3 opacity-50">medical_services</span>
                                <p class="text-sm font-medium">No hay siniestros registrados.</p>
                            </div>
                        </div>
                    </div>

                    <div
                        class="bg-gradient-to-r from-indigo-900/40 to-[#1f242e] border border-indigo-500/30 rounded-xl p-4 flex items-start gap-4 shadow-lg shadow-indigo-900/10">
                        <div class="p-2 bg-indigo-500/20 rounded-lg text-indigo-300 mt-1">
                            <span class="material-symbols-outlined">auto_awesome</span>
                        </div>
                        <div>
                            <h4 class="text-indigo-200 text-sm font-bold mb-1">Sugerencia IA</h4>
                            <p class="text-sm text-indigo-100/80 leading-relaxed">
                                Mant√©n actualizada la bit√°cora de tus siniestros "En Revisi√≥n" cada 3 d√≠as para mejorar
                                la satisfacci√≥n del cliente.
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <div id="modalSiniestro"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in overflow-y-auto">
            <div
                class="bg-[#1c1f27] border border-[#3b4354] rounded-xl w-full max-w-2xl p-6 shadow-2xl transform transition-all scale-100 my-8">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white mb-1">Registrar Nuevo Siniestro</h2>
                        <p class="text-[#94a3b8] text-sm">Vincula el siniestro a una p√≥liza existente.</p>
                    </div>
                    <button onclick="cerrarModalSiniestro()" class="text-[#94a3b8] hover:text-white"><span
                            class="material-symbols-outlined">close</span></button>
                </div>

                <form id="formSiniestro" onsubmit="guardarSiniestro(event)" class="space-y-6">

                    <div class="relative">
                        <label class="block text-xs font-medium text-[#94a3b8] mb-1">Buscar P√≥liza Afectada (Escribe
                            nombre o n√∫mero)</label>
                        <input type="text" id="polizaSearchInput" autocomplete="off" onkeyup="filtrarPolizasUI()"
                            placeholder="Ej: Juan P√©rez o AUTO-123..."
                            class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2.5 text-white focus:border-primary outline-none">
                        <input type="hidden" id="polizaIndexHidden">
                        <div id="dropdownResultados"
                            class="hidden absolute z-50 w-full bg-[#1c1f27] border border-[#3b4354] rounded-lg mt-1 max-h-48 overflow-y-auto shadow-2xl">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-[#94a3b8] mb-1">Fecha del Evento</label>
                            <input type="date" id="fechaSiniestro" required
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2.5 text-white">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-[#94a3b8] mb-1">Tipo de Siniestro</label>
                            <select id="tipoSiniestro"
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2.5 text-white">
                                <option value="Colisi√≥n Vehicular">Colisi√≥n Vehicular</option>
                                <option value="Robo Total">Robo Total</option>
                                <option value="Gastos M√©dicos">Gastos M√©dicos</option>
                                <option value="Cristalazo">Cristalazo</option>
                                <option value="Responsabilidad Civil">Responsabilidad Civil</option>
                                <option value="Hogar">Hogar / Da√±os</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-[#94a3b8] mb-1">Prioridad / Status
                                Inicial</label>
                            <select id="statusSiniestro"
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2.5 text-white">
                                <option value="Abierto">Abierto (Normal)</option>
                                <option value="Urgente">Urgente</option>
                                <option value="En Revisi√≥n">En Revisi√≥n</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-[#94a3b8] mb-1">Monto Estimado
                                (Opcional)</label>
                            <input type="number" id="montoSiniestro" placeholder="0.00"
                                class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2.5 text-white">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-[#94a3b8] mb-1">Descripci√≥n de los hechos</label>
                        <textarea id="descSiniestro" rows="3"
                            class="w-full bg-[#111318] border border-[#3b4354] rounded-lg p-2.5 text-white resize-none"
                            placeholder="Describe brevemente lo ocurrido..."></textarea>
                    </div>
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-[#3b4354]">
                        <button type="button" onclick="cerrarModalSiniestro()"
                            class="px-4 py-2 text-sm font-medium text-[#9da6b9] hover:text-white">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-primary hover:bg-blue-600 text-white text-sm font-bold rounded-lg shadow-lg shadow-primary/30">Registrar
                            Siniestro</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="modalDetalleSiniestro"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade-in overflow-y-auto">
            <div
                class="bg-[#1c1f27] border border-[#3b4354] rounded-xl w-full max-w-3xl p-0 shadow-2xl transform transition-all scale-100 my-8 overflow-hidden">
                <div
                    class="bg-gradient-to-r from-[#161b22] to-[#2d3442] p-6 border-b border-[#3b4354] flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <span
                                class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs font-bold border border-blue-500/20"
                                id="detStatusBadge">ABIERTO</span>
                            <span class="text-[#94a3b8] text-xs font-mono" id="detID">#SIN-0000</span>
                        </div>
                        <h2 class="text-xl font-bold text-white mb-1" id="detTitulo">Detalle del Siniestro</h2>
                        <p class="text-[#94a3b8] text-sm" id="detSubtitulo">P√≥liza: ---</p>
                    </div>
                    <button onclick="cerrarDetalle()"
                        class="text-[#94a3b8] hover:text-white p-1 rounded-full hover:bg-white/10"><span
                            class="material-symbols-outlined">close</span></button>
                </div>

                <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 space-y-6">
                        <div class="bg-[#111318] p-4 rounded-lg border border-[#3b4354]">
                            <label class="block text-xs font-bold text-[#94a3b8] uppercase mb-2">Actualizar
                                Estatus</label>
                            <div class="flex gap-2">
                                <select id="detStatusSelect"
                                    class="flex-1 bg-[#1c1f27] border border-[#3b4354] rounded-lg p-2 text-white text-sm">
                                    <option value="Abierto">Abierto</option>
                                    <option value="En Revisi√≥n">En Revisi√≥n</option>
                                    <option value="Taller/Hospital">Taller / Hospital</option>
                                    <option value="Pagado">Pagado</option>
                                    <option value="Rechazado">Rechazado</option>
                                    <option value="Cerrado">Cerrado</option>
                                </select>
                                <button onclick="guardarCambiosSiniestro()"
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-bold transition-colors">Actualizar</button>
                            </div>
                        </div>

                        <div class="bg-[#111318] p-4 rounded-lg border border-[#3b4354]">
                            <h4 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-sm">history_edu</span> Bit√°cora
                                de Seguimiento
                            </h4>
                            <div id="listaBitacora" class="space-y-3 max-h-48 overflow-y-auto custom-scroll pr-2 mb-3">
                                <p class="text-[#94a3b8] text-xs italic">No hay notas registradas.</p>
                            </div>
                            <div class="flex gap-2 border-t border-[#3b4354] pt-3">
                                <input type="text" id="nuevaNotaInput" placeholder="Escribe una nota de avance..."
                                    class="flex-1 bg-[#1c1f27] border border-[#3b4354] rounded-lg p-2 text-white text-sm focus:border-primary outline-none">
                                <button onclick="agregarNota()"
                                    class="bg-[#2d3442] hover:bg-primary text-white px-3 py-2 rounded-lg transition-colors border border-[#3b4354]"><span
                                        class="material-symbols-outlined text-sm">send</span></button>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-bold text-white flex items-center gap-2"><span
                                        class="material-symbols-outlined text-yellow-500 text-sm">folder</span>
                                    Documentos y Evidencia</h4>
                                <button onclick="agregarDocumentoSimulado()"
                                    class="text-primary text-xs font-bold hover:underline flex items-center gap-1"><span
                                        class="material-symbols-outlined text-xs">upload</span> Subir Archivo</button>
                            </div>
                            <div id="listaDocumentos" class="space-y-2">
                                <p class="text-[#94a3b8] text-xs italic">No hay documentos adjuntos.</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="p-3 bg-[#111318] rounded-lg border border-[#3b4354]">
                            <p class="text-[#94a3b8] text-xs mb-1">Descripci√≥n Inicial</p>
                            <p class="text-white text-xs leading-relaxed" id="detDescripcion">---</p>
                        </div>
                        <div class="p-3 bg-[#111318] rounded-lg border border-[#3b4354]">
                            <p class="text-[#94a3b8] text-xs mb-1">Fecha Siniestro</p>
                            <p class="text-white font-medium text-sm" id="detFecha">---</p>
                        </div>
                        <div class="p-3 bg-[#111318] rounded-lg border border-[#3b4354]">
                            <p class="text-[#94a3b8] text-xs mb-1">Aseguradora</p>
                            <p class="text-white font-medium text-sm" id="detAseguradora">---</p>
                        </div>
                        <div class="p-3 bg-[#111318] rounded-lg border border-[#3b4354]">
                            <p class="text-[#94a3b8] text-xs mb-1">Monto Estimado</p>
                            <p class="text-white font-mono font-bold text-lg text-green-400" id="detMonto">---</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="menu.js"></script>

    <script>
        let siniestrosGlobales = [];
        let polizasDisponibles = [];
        let siniestroActualIndex = null;

        async function cargarSiniestros() {
            // --- CONSULTA SUPABASE ---
            const { data: siniestros } = await window.supabaseClient.from('siniestros').select('*');
            const { data: polizas } = await window.supabaseClient.from('polizas').select('*');

            siniestrosGlobales = siniestros || [];
            polizasDisponibles = polizas || [];

            actualizarKPIs();
            renderTabla(siniestrosGlobales);
        }

        function actualizarKPIs() {
            const abiertos = siniestrosGlobales.filter(s => s.status === 'Abierto').length;
            const revision = siniestrosGlobales.filter(s => s.status === 'En Revisi√≥n').length;
            const cerrados = siniestrosGlobales.filter(s => s.status === 'Cerrado').length;
            const urgentes = siniestrosGlobales.filter(s => s.status === 'Urgente').length;

            document.getElementById('kpiAbiertos').innerText = abiertos;
            document.getElementById('kpiRevision').innerText = revision;
            document.getElementById('kpiCerrados').innerText = cerrados;
            document.getElementById('kpiUrgentes').innerText = urgentes;
        }

        async function renderTabla(datos) {
            const tbody = document.getElementById('tablaSiniestros');
            const sinDatos = document.getElementById('sin-datos');
            tbody.innerHTML = '';

            if (!datos || datos.length === 0) {
                sinDatos.classList.remove('hidden');
                return;
            } else {
                sinDatos.classList.add('hidden');
            }

            datos.forEach((s, index) => {
                let badgeClass = "";
                let dotColor = "";

                if (s.status === 'En Revisi√≥n' || s.status === 'Taller/Hospital') { badgeClass = "bg-yellow-500/10 text-yellow-500 border border-yellow-500/20"; dotColor = "bg-yellow-500"; }
                else if (s.status === 'Abierto') { badgeClass = "bg-blue-500/10 text-blue-400 border border-blue-500/20"; dotColor = "bg-blue-400"; }
                else if (s.status === 'Urgente') { badgeClass = "bg-red-500/10 text-red-400 border border-red-500/20 animate-pulse"; dotColor = "bg-red-400"; }
                else if (s.status === 'Cerrado' || s.status === 'Pagado') { badgeClass = "bg-green-500/10 text-green-400 border border-green-500/20"; dotColor = "bg-green-400"; }
                else { badgeClass = "bg-gray-500/10 text-gray-400 border border-gray-500/20"; dotColor = "bg-gray-400"; }

                let icon = "folder";
                const tipoLower = s.tipo.toLowerCase();
                if (tipoLower.includes("vehicular") || tipoLower.includes("cristalazo")) icon = "car_crash";
                if (tipoLower.includes("m√©dicos")) icon = "medical_services";
                if (tipoLower.includes("hogar")) icon = "home_work";

                if (tipoLower.includes("m√©dicos")) icon = "medical_services";
                if (tipoLower.includes("hogar")) icon = "home_work";

                const fechaDisplay = window.SegumexDate.toDisplay(s.fecha);
                const diffDays = Math.abs(window.SegumexDate.diffDays(s.fecha));
                const haceTexto = diffDays <= 1 ? "Hoy" : `Hace ${diffDays} d√≠as`;
                const iniciales = s.titular ? s.titular.substring(0, 2).toUpperCase() : "NA";

                tbody.innerHTML += `
                <tr class="hover:bg-[#1a202a] transition-colors group border-b border-[#2d3442] last:border-0">
                    <td class="p-4">
                        <div class="flex flex-col">
                            <span class="text-white font-bold text-sm font-mono text-primary cursor-pointer hover:underline" onclick="abrirDetalle(${index})">${s.id}</span>
                            <span class="text-[#94a3b8] text-[10px] uppercase tracking-wide">${s.poliza_numero}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded-full bg-[#2d3442] flex items-center justify-center text-[10px] font-bold text-white shadow-md border border-[#3b4354]">
                                ${iniciales}
                            </div>
                            <div class="flex flex-col">
                                <span class="text-white font-medium text-sm">${s.titular}</span>
                                <span class="text-[#94a3b8] text-xs">${s.aseguradora}</span>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-[#94a3b8] text-[18px]">${icon}</span>
                            <span class="text-white text-sm">${s.tipo}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <div class="flex flex-col">
                            <span class="text-white font-medium text-sm">${fechaDisplay}</span>
                            <span class="text-[#94a3b8] text-xs">${haceTexto}</span>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[11px] font-medium ${badgeClass}">
                            <span class="size-1.5 rounded-full ${dotColor}"></span> ${s.status}
                        </span>
                    </td>
                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                            <button onclick="abrirDetalle(${index})" class="p-1.5 rounded-md hover:bg-[#2d3442] text-[#94a3b8] hover:text-white transition-colors" title="Ver Detalle / Editar"><span class="material-symbols-outlined text-[18px]">visibility</span></button>
                            <button onclick="borrarSiniestro(${index})" class="p-1.5 rounded-md hover:bg-[#2d3442] text-[#94a3b8] hover:text-red-500 transition-colors" title="Eliminar"><span class="material-symbols-outlined text-[18px]">delete</span></button>
                        </div>
                    </td>
                </tr>
            `;
            });
        }

        function aplicarFiltros() {
            const texto = document.getElementById('buscador').value.toLowerCase();
            const status = document.getElementById('filtroStatus').value;
            const filtrados = siniestrosGlobales.filter(s => {
                const matchTexto = (s.titular || "").toLowerCase().includes(texto) || (s.id || "").toLowerCase().includes(texto) || (s.poliza_numero || "").toLowerCase().includes(texto);
                const matchStatus = status === 'Todos' || s.status === status;
                return matchTexto && matchStatus;
            });
            renderTabla(filtrados);
        }

        function abrirModalSiniestro() {
            document.getElementById('modalSiniestro').classList.remove('hidden');
            document.getElementById('formSiniestro').reset();
            document.getElementById('polizaIndexHidden').value = "";
            document.getElementById('polizaSearchInput').value = "";
        }

        async function filtrarPolizasUI() {
            const texto = document.getElementById('polizaSearchInput').value.toLowerCase();
            const dropdown = document.getElementById('dropdownResultados');

            if (texto.length < 1) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.classList.remove('hidden');
            dropdown.innerHTML = '';

            const { data: clientes } = await window.supabaseClient.from('clientes').select('id, nombre, apellido');

            const coincidencias = polizasDisponibles.map((p, index) => {
                const match = (clientes || []).find(c => String(c.id) === String(p.cliente_id));
                let nombreCliente = match ? `${match.nombre} ${match.apellido || ''}` : "Cliente Desconocido";
                return { index, p, nombreCliente };
            }).filter(item => {
                return (item.p.no_poliza || "").toLowerCase().includes(texto) ||
                    item.nombreCliente.toLowerCase().includes(texto) ||
                    (item.p.aseguradora || "").toLowerCase().includes(texto);
            });

            if (coincidencias.length === 0) {
                dropdown.innerHTML = `<div class="p-3 text-xs text-[#94a3b8]">No se encontraron p√≥lizas.</div>`;
                return;
            }

            coincidencias.forEach(item => {
                dropdown.innerHTML += `
                <div onclick="seleccionarPoliza(${item.index}, '${item.p.no_poliza}', '${item.nombreCliente}')" class="p-3 hover:bg-[#2d3442] cursor-pointer border-b border-[#3b4354] last:border-0">
                    <p class="text-white text-sm font-bold">${item.nombreCliente}</p>
                    <p class="text-[#94a3b8] text-xs">${item.p.no_poliza} ‚Ä¢ ${item.p.aseguradora}</p>
                </div>
            `;
            });
        }

        function seleccionarPoliza(index, numero, cliente) {
            document.getElementById('polizaSearchInput').value = `${cliente} - ${numero}`;
            document.getElementById('polizaIndexHidden').value = index;
            document.getElementById('dropdownResultados').classList.add('hidden');
        }

        function cerrarModalSiniestro() {
            document.getElementById('modalSiniestro').classList.add('hidden');
            document.getElementById('dropdownResultados').classList.add('hidden');
        }

        async function guardarSiniestro(e) {
            e.preventDefault();
            const indexPoliza = document.getElementById('polizaIndexHidden').value;
            if (indexPoliza === "") { alert("Debes seleccionar una p√≥liza v√°lida."); return; }

            const polizaSeleccionada = polizasDisponibles[indexPoliza];
            const textoInput = document.getElementById('polizaSearchInput').value;
            const nombreTitular = textoInput.split('-')[0].trim();

            // 1. Insertar el Siniestro primero (para tener su ID real si fuera necesario, aunque aqu√≠ usaremos la respuesta)
            const nuevoSiniestro = {
                // id: Autogenerado por DB
                poliza_id: polizaSeleccionada.id,
                poliza_numero: polizaSeleccionada.no_poliza,
                aseguradora: polizaSeleccionada.aseguradora,
                titular: nombreTitular,
                fecha: window.SegumexDate.toISO(document.getElementById('fechaSiniestro').value),
                tipo: document.getElementById('tipoSiniestro').value,
                status: statusActual,
                monto: document.getElementById('montoSiniestro').value || 0,
                descripcion: document.getElementById('descSiniestro').value,
                documentos: [],
                bitacora: [{ fecha: new Date().toISOString(), texto: "Siniestro registrado en sistema." }]
            };

            const btnSubmit = document.querySelector('#formSiniestro button[type="submit"]');
            window.SegumexUI.setLoading(btnSubmit, "Registrando...");

            const { data: dataSiniestro, error: errorSiniestro } = await window.supabaseClient
                .from('siniestros')
                .insert([nuevoSiniestro])
                .select();

            if (errorSiniestro) {
                console.error(errorSiniestro);
                window.SegumexUI.resetLoading(btnSubmit);
                alert("Error creando siniestro");
                return;
            }

            const siniestroReal = dataSiniestro[0];

            // 2. Crear Tarea Autom√°tica (ID autogenerado por DB tambi√©n)
            const tareaSiniestro = {
                titulo: `${statusActual === 'Urgente' ? 'üÜò' : 'üìã'} Siniestro: ${siniestroReal.titular}`,
                descripcion: `Seguimiento de siniestro ${siniestroReal.tipo}. P√≥liza: ${siniestroReal.poliza_numero}. ID Siniestro: ${siniestroReal.id}`,
                fecha: siniestroReal.fecha,
                prioridad: statusActual === "Urgente" ? "Urgente" : "Media",
                completada: false
            };

            await window.supabaseClient.from('tareas').insert([tareaSiniestro]);

            window.SegumexUI.resetLoading(btnSubmit);

            cerrarModalSiniestro();
            await cargarSiniestros();
        }

        function abrirDetalle(index) {
            siniestroActualIndex = index;
            const s = siniestrosGlobales[index];
            document.getElementById('modalDetalleSiniestro').classList.remove('hidden');
            document.getElementById('detID').innerText = s.id;
            document.getElementById('detTitulo').innerText = `${s.tipo} - ${s.titular}`;
            document.getElementById('detSubtitulo').innerText = `P√≥liza: ${s.poliza_numero} (${s.aseguradora})`;
            document.getElementById('detStatusBadge').innerText = s.status.toUpperCase();
            document.getElementById('detDescripcion').innerText = s.descripcion || "Sin descripci√≥n.";
            document.getElementById('detFecha').innerText = window.SegumexDate.toDisplay(s.fecha);
            document.getElementById('detAseguradora').innerText = s.aseguradora;
            document.getElementById('detMonto').innerText = s.monto ? new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(s.monto) : "Por definir";
            document.getElementById('detStatusSelect').value = s.status;
            renderDocumentos(s.documentos || []);
            renderBitacora(s.bitacora || []);
        }

        function cerrarDetalle() { document.getElementById('modalDetalleSiniestro').classList.add('hidden'); }

        async function guardarCambiosSiniestro() {
            const nuevoStatus = document.getElementById('detStatusSelect').value;
            const s = siniestrosGlobales[siniestroActualIndex];
            const anterior = s.status;

            if (nuevoStatus !== anterior) {
                const btnActualizar = document.querySelector('button[onclick="guardarCambiosSiniestro()"]');
                window.SegumexUI.setLoading(btnActualizar, "Actualizando...");

                const nuevaBitacora = [...(s.bitacora || []), { fecha: new Date().toISOString(), texto: `Estatus actualizado: ${anterior} ‚ûù ${nuevoStatus}` }];

                const { error } = await window.supabaseClient.from('siniestros')
                    .update({ status: nuevoStatus, bitacora: nuevaBitacora })
                    .eq('id', s.id);

                window.SegumexUI.resetLoading(btnActualizar);

                if (!error) {
                    await cargarSiniestros();
                    abrirDetalle(siniestroActualIndex);
                }
            }
        }

        async function agregarNota() {
            const input = document.getElementById('nuevaNotaInput');
            if (!input.value.trim()) return;
            const s = siniestrosGlobales[siniestroActualIndex];
            const nuevaBitacora = [...(s.bitacora || []), { fecha: new Date().toISOString(), texto: input.value.trim() }];

            await window.supabaseClient.from('siniestros')
                .update({ bitacora: nuevaBitacora })
                .eq('id', s.id);

            input.value = "";
            await cargarSiniestros();
            renderBitacora(siniestrosGlobales[siniestroActualIndex].bitacora);
        }

        function renderBitacora(notas) {
            const contenedor = document.getElementById('listaBitacora');
            contenedor.innerHTML = '';
            [...(notas || [])].reverse().forEach(nota => {
                const f = new Date(nota.fecha);
                contenedor.innerHTML += `<div class="flex gap-3 items-start pb-3"><div class="size-2 rounded-full bg-primary mt-1"></div><div class="bg-[#1c1f27] p-2 rounded-lg border border-[#3b4354]"><p class="text-white text-sm">${nota.texto}</p><p class="text-[#586074] text-[10px] mt-1">${f.toLocaleDateString()} ‚Ä¢ ${f.toLocaleTimeString()}</p></div></div>`;
            });
        }

        async function agregarDocumentoSimulado() {
            const nombre = prompt("Nombre del archivo:", "Evidencia.pdf");
            if (nombre) {
                const s = siniestrosGlobales[siniestroActualIndex];
                const nuevosDocumentos = [...(s.documentos || []), { nombre, fecha: new Date().toLocaleDateString(), tipo: 'PDF' }];

                await window.supabaseClient.from('siniestros')
                    .update({ documentos: nuevosDocumentos })
                    .eq('id', s.id);

                await cargarSiniestros();
                renderDocumentos(siniestrosGlobales[siniestroActualIndex].documentos);
            }
        }

        function renderDocumentos(docs) {
            const cont = document.getElementById('listaDocumentos');
            cont.innerHTML = (docs && docs.length) ? '' : '<p class="text-[#94a3b8] text-xs italic">No hay documentos.</p>';
            (docs || []).forEach(d => { cont.innerHTML += `<div class="flex items-center gap-3 p-2 bg-[#1c1f27] border border-[#3b4354] rounded-lg"><span class="material-symbols-outlined text-red-400 text-lg">picture_as_pdf</span><div class="flex-1 overflow-hidden"><p class="text-white text-xs font-bold truncate">${d.nombre}</p></div></div>`; });
        }

        async function borrarSiniestro(index) {
            if (confirm("¬øEliminar siniestro?")) {
                const id = siniestrosGlobales[index].id;
                const { error } = await window.supabaseClient.from('siniestros').delete().eq('id', id);
                if (!error) await cargarSiniestros();
            }
        }
    </script>
</body>

</html>