<!DOCTYPE html>
<html class="dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard - Segumex</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />

    <!-- PWA Icons for Apple -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
    <script>
        // --- SEGURIDAD: Verificar sesión activa en Supabase ---
        async function checkSession() {
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
        }
        checkSession();

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "background-dark": "#101622",
                        "surface-dark": "#111318",
                        "surface-card": "#1c1f27",
                        "text-secondary": "#9da6b9"
                    },
                    fontFamily: { "display": ["Inter", "sans-serif"] }
                },
            },
        }
    </script>
</head>

<body class="bg-[#f6f6f8] dark:bg-background-dark font-display text-white relative">
    <!-- Overlay Mobile -->
    <div id="sidebarOverlay" onclick="toggleMenu()"
        class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass transition-opacity"></div>

    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside id="sidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-[#3b4354] bg-[#111318] flex-shrink-0 shadow-2xl md:shadow-none">
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-y-auto bg-background-dark relative w-full">
            <!-- Mobile Header / Toggle -->
            <div class="md:hidden p-4 pb-0 flex items-center gap-3">
                <button onclick="toggleMenu()" class="p-2 -ml-2 text-white hover:bg-white/10 rounded-lg">
                    <span class="material-symbols-outlined text-2xl">menu</span>
                </button>
                <span class="font-bold text-lg">Segumex</span>
            </div>

            <div class="p-4 md:p-8 max-w-7xl mx-auto w-full pb-20">

                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Resumen General</h1>
                        <p class="text-[#9da6b9] text-sm hidden md:block">Bienvenido de nuevo. Aquí está lo que sucede
                            hoy.</p>
                    </div>
                    <div class="flex flex-row flex-wrap items-center gap-3">
                        <div
                            class="flex items-center gap-2 bg-surface-card border border-[#3b4354] rounded-lg p-1.5 flex-grow md:flex-grow-0">
                            <label class="text-[10px] text-[#9da6b9] font-bold uppercase ml-2">Periodo:</label>
                            <select id="filtroPeriodo" onchange="actualizarDashboard()"
                                class="bg-transparent border-none text-white text-xs py-1 focus:ring-0 cursor-pointer">
                                <option value="mensual" class="bg-surface-card">Mes en curso</option>
                                <option value="semestral" class="bg-surface-card">Últimos 6 meses</option>
                                <option value="anual" class="bg-surface-card">Año actual</option>
                            </select>
                        </div>
                        <a href="clientes.html"
                            class="px-4 py-2 bg-primary hover:bg-blue-600 text-white text-sm font-bold rounded-lg shadow-lg shadow-primary/30 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-[20px]">person_add</span> Nuevo Cliente
                        </a>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-surface-card border border-[#3b4354] rounded-xl p-6 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="material-symbols-outlined text-6xl text-green-500">attach_money</span>
                        </div>
                        <p class="text-[#9da6b9] text-sm font-medium mb-1">Comisiones</p>
                        <h2 class="text-3xl font-bold text-white flex items-center gap-2">
                            <span id="kpiComisiones">$0.00</span>
                        </h2>
                        <p class="text-xs text-[#9da6b9] mt-2">Pagos liquidados en periodo seleccionado</p>
                    </div>

                    <div class="bg-surface-card border border-[#3b4354] rounded-xl p-6 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="material-symbols-outlined text-6xl text-blue-500">group</span>
                        </div>
                        <p class="text-[#9da6b9] text-sm font-medium mb-1">Clientes Totales</p>
                        <h2 class="text-3xl font-bold text-white" id="kpiClientes">0</h2>
                        <p class="text-xs text-[#9da6b9] mt-2">Total histórico registrado</p>
                    </div>

                    <div class="bg-surface-card border border-[#3b4354] rounded-xl p-6 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-6 opacity-10 group-hover:opacity-20 transition-opacity">
                            <span class="material-symbols-outlined text-6xl text-purple-500">verified_user</span>
                        </div>
                        <p class="text-[#9da6b9] text-sm font-medium mb-1">Pólizas Activas</p>
                        <h2 class="text-3xl font-bold text-white" id="kpiPolizas">0</h2>
                        <p class="text-xs text-[#9da6b9] mt-2">Total de pólizas no canceladas</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div
                        class="bg-surface-card border border-[#3b4354] rounded-xl overflow-hidden flex flex-col shadow-lg">
                        <div class="p-4 border-b border-[#3b4354] bg-blue-500/5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-400 text-lg">calendar_month</span>
                                Pagos Próximos
                            </h3>
                            <span
                                class="text-[10px] bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded font-bold uppercase">7
                                días</span>
                        </div>
                        <div class="flex-1 p-0 overflow-y-auto max-h-[350px]" id="listaPagosProximos"></div>
                    </div>

                    <div
                        class="bg-surface-card border border-[#3b4354] rounded-xl overflow-hidden flex flex-col shadow-lg border-t-red-500/50">
                        <div class="p-4 border-b border-[#3b4354] bg-red-500/5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm flex items-center gap-2">
                                <span class="material-symbols-outlined text-red-500 text-lg">error</span> Pagos Vencidos
                            </h3>
                            <span
                                class="text-[10px] bg-red-500/20 text-red-300 px-2 py-0.5 rounded font-bold uppercase">Urgente</span>
                        </div>
                        <div class="flex-1 p-0 overflow-y-auto max-h-[350px]" id="listaPagosVencidos"></div>
                    </div>

                    <div
                        class="bg-surface-card border border-[#3b4354] rounded-xl overflow-hidden flex flex-col shadow-lg">
                        <div class="p-4 border-b border-[#3b4354] bg-purple-500/5 flex justify-between items-center">
                            <h3 class="font-bold text-white text-sm flex items-center gap-2">
                                <span class="material-symbols-outlined text-purple-400 text-lg">autorenew</span>
                                Renovaciones
                            </h3>
                            <span
                                class="text-[10px] bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded font-bold uppercase">45
                                días</span>
                        </div>
                        <div class="flex-1 p-0 overflow-y-auto max-h-[350px]" id="listaRenovaciones"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-surface-card border border-[#3b4354] rounded-xl overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-[#3b4354] flex justify-between items-center">
                            <h3 class="font-bold text-white">Últimos Clientes</h3>
                            <a href="clientes.html" class="text-xs text-primary hover:text-white transition-colors">Ver
                                todos</a>
                        </div>
                        <div class="flex-1 p-4" id="listaUltimosClientes"></div>
                    </div>

                    <div class="bg-surface-card border border-[#3b4354] rounded-xl overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-[#3b4354]">
                            <h3 class="font-bold text-white">Actividad Reciente</h3>
                        </div>
                        <div class="p-6 text-sm text-[#9da6b9]">
                            Acciones rápidas del sistema para el día de hoy.
                            <div class="space-y-4 mt-4">
                                <a href="clientes.html"
                                    class="block p-4 rounded-lg bg-[#111318] border border-[#3b4354] hover:border-primary transition-colors group">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="size-10 rounded-full bg-primary/10 text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-colors">
                                            <span class="material-symbols-outlined">person_search</span>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-bold">Buscar Cliente</h4>
                                            <p class="text-xs">Accede al directorio completo</p>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="menu.js"></script>

    <script>
        // normalizeDate eliminado, usamos window.SegumexDate

        async function actualizarDashboard() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const hoy = new Date();
            let inicioRango = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            let finRango = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);

            if (periodo === 'semestral') {
                inicioRango = new Date();
                inicioRango.setMonth(hoy.getMonth() - 6);
            } else if (periodo === 'anual') {
                inicioRango = new Date(hoy.getFullYear(), 0, 1);
            }

            // --- LLAMADAS A SUPABASE ---
            const { data: clientesData } = await window.supabaseClient.from('clientes').select('*');
            const { data: polizasData } = await window.supabaseClient.from('polizas').select('*');

            // --- FILTRO DE SEGURIDAD (Restringidos) ---
            const sesion = JSON.parse(localStorage.getItem('segumex_sesion')) || {};
            const esAdmin = sesion.rol === 'admin';

            // AQUÍ ESTABA EL ERROR: La DB usa 'restringida' (femenino) no 'restringido'
            const clientes = (clientesData || []).filter(c => esAdmin || c.restringida !== true);

            // Filtramos las pólizas también 
            const polizas = (polizasData || []).filter(p => esAdmin || p.restringida !== true);

            const polizasActivas = polizas.filter(p => p.estado !== 'cancelada');

            // 1. Clientes Totales
            document.getElementById('kpiClientes').innerText = (clientes || []).length;

            // 2. Pólizas Activas
            document.getElementById('kpiPolizas').innerText = polizasActivas.length;

            // 3. Comisiones
            let totalComisiones = 0;
            polizasActivas.forEach(p => {
                const f = p.finanzas || {};
                const numPagos = parseInt(f.formaPago) || 1;
                const primaNeta = parseFloat(f.primaNeta) || 0;
                const pct = parseFloat(f.comisionPct) || 10;
                const bonoTotal = parseFloat(f.moduloHDI) || 0;
                const comisionPorPago = ((primaNeta / numPagos) * (pct / 100)) + (bonoTotal / numPagos);

                if (p.pagos_status && p.pagos_fechas) {
                    p.pagos_status.forEach((status, idx) => {
                        if (status === true && p.pagos_fechas[idx]) {
                            const fPago = window.SegumexDate.parse(p.pagos_fechas[idx]);
                            if (fPago && fPago >= inicioRango && fPago <= finRango) {
                                totalComisiones += comisionPorPago;
                            }
                        }
                    });
                }
            });
            document.getElementById('kpiComisiones').innerText = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalComisiones);

            renderTablasOperativas(clientes || [], polizasActivas);
        }

        function renderTablasOperativas(clientes, polizasActivas) {
            const hoyObj = new Date(); hoyObj.setHours(0, 0, 0, 0);
            let htmlProx = '', htmlVenc = '', htmlRenov = '';

            polizasActivas.forEach(p => {
                // IMPORTANTISIMO: Buscar el cliente en la lista FILTRADA 'clientes'
                // Si el cliente fue filtrado arriba (por ser restringido), find() retornará undefined
                const cliente = clientes.find(c => String(c.id) === String(p.cliente_id));

                // Si no encontramos al cliente (porque está restringido y oculto), saltamos esta póliza
                if (!cliente) return;

                const nombreCli = `${cliente.nombre} ${cliente.apellido || ''}`;
                const telCli = cliente.telefono || "";

                if (p.finanzas?.inicio) {
                    const numPagos = parseInt(p.finanzas.formaPago) || 1;
                    const montoPago = (parseFloat(p.finanzas.primaTotal) || parseFloat(p.prima) || 0) / numPagos;

                    // Usamos la fecha de inicio parseada
                    let fechaIterada = window.SegumexDate.parse(p.finanzas.inicio);

                    for (let i = 0; i < numPagos; i++) {
                        const pagado = p.pagos_status && p.pagos_status[i] === true;
                        if (!pagado && fechaIterada) {
                            const diffDias = window.SegumexDate.diffDays(fechaIterada);
                            const fechaStr = window.SegumexDate.toShortDisplay(fechaIterada);

                            const itemHtml = `<div class="p-3 border-b border-[#3b4354] hover:bg-white/5 transition-colors flex justify-between items-center group"><div class="overflow-hidden pr-2"><p class="text-white text-[11px] font-bold truncate">${nombreCli}</p><p class="text-[#9da6b9] text-[10px]">${p.no_poliza || p.numero || 'S/N'} • $${montoPago.toFixed(2)}</p></div><div class="flex flex-col items-end gap-1 shrink-0"><span class="text-[10px] font-mono ${diffDias < 0 ? 'text-red-500 font-bold' : 'text-blue-400'}">${fechaStr}</span><button onclick="enviarWhatsApp('${telCli}', 'cobranza', '${nombreCli}', '${p.no_poliza || p.numero || 'S/N'}', '${montoPago.toFixed(2)}', ${diffDias})" class="opacity-0 group-hover:opacity-100 transition-opacity text-green-500 hover:scale-110"><span class="material-symbols-outlined text-sm">chat</span></button></div></div>`;

                            if (diffDias < 0) htmlVenc += itemHtml;
                            else if (diffDias <= 7) htmlProx += itemHtml;
                        }
                        // Avanzar meses
                        if (fechaIterada) fechaIterada.setMonth(fechaIterada.getMonth() + (12 / numPagos));
                    }
                }

                if (p.vence) {
                    const diffDiasRenov = window.SegumexDate.diffDays(p.vence);
                    const fechaVenceStr = window.SegumexDate.toDisplay(p.vence);

                    if (diffDiasRenov >= 0 && diffDiasRenov <= 45) {
                        htmlRenov += `<div class="p-3 border-b border-[#3b4354] hover:bg-white/5 transition-colors flex justify-between items-center group"><div class="overflow-hidden pr-2"><p class="text-white text-[11px] font-bold truncate">${nombreCli}</p><p class="text-[#9da6b9] text-[10px]">${p.no_poliza || p.numero || 'S/N'} • ${p.aseguradora || 'Aseguradora'}</p></div><div class="flex flex-col items-end gap-1 shrink-0"><span class="text-[10px] font-mono text-purple-400">${fechaVenceStr}</span><button onclick="enviarWhatsApp('${telCli}', 'renovacion', '${nombreCli}', '${p.no_poliza || p.numero || 'S/N'}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-green-500 hover:scale-110"><span class="material-symbols-outlined text-sm">chat</span></button></div></div>`;
                    }
                }
            });

            document.getElementById('listaPagosProximos').innerHTML = htmlProx || '<div class="p-8 text-center text-[#9da6b9] text-[10px] italic">No hay pagos cercanos</div>';
            document.getElementById('listaPagosVencidos').innerHTML = htmlVenc || '<div class="p-8 text-center text-[#9da6b9] text-[10px] italic">Sin cartera vencida</div>';
            document.getElementById('listaRenovaciones').innerHTML = htmlRenov || '<div class="p-8 text-center text-[#9da6b9] text-[10px] italic">Sin renovaciones próximas</div>';

            const listaUltimos = document.getElementById('listaUltimosClientes');
            if (clientes.length > 0) {
                listaUltimos.innerHTML = '';
                // Mostrar ÚNICAMENTE clientes que ya pasaron el filtro (esto ocultará los restringidos automágicamente)
                clientes.slice(-3).reverse().forEach(c => {
                    listaUltimos.innerHTML += `<div class="flex items-center gap-3 mb-4 last:mb-0"><div class="size-10 rounded-full bg-[#1c1f27] border border-[#3b4354] flex items-center justify-center font-bold text-white text-xs">${c.nombre.charAt(0).toUpperCase()}</div><div class="flex-1"><h4 class="text-white text-sm font-medium">${c.nombre} ${c.apellido || ''}</h4><p class="text-[#9da6b9] text-xs">${c.telefono || 'Sin teléfono'}</p></div><span class="text-xs text-green-400 bg-green-500/10 px-2 py-1 rounded border border-green-500/20">Nuevo</span></div>`;
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            actualizarDashboard();
        });

        function enviarWhatsApp(tel, tipo, nombre, poliza, monto = "", diffDias = 0) {
            if (!tel) { alert("El cliente no tiene teléfono registrado."); return; }
            const num = tel.replace(/\D/g, '');
            let msg = (tipo === 'cobranza')
                ? (diffDias < 0 ? `Hola ${nombre}, tu pago de $${monto} (Póliza ${poliza}) venció. ¿Nos confirmas si ya lo realizaste?` : `Hola ${nombre}, te recordamos tu próximo pago de $${monto} (Póliza ${poliza}).`)
                : `Hola ${nombre}, tu póliza ${poliza} vence pronto. ¿Iniciamos la renovación?`;
            window.open(`https://wa.me/52${num}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>

</html>